#
# Measure convergence rates for CgWave
#
#     conv.p tests.conv -option=[planeWave|helmholtz|squareEig|diskEig|annulusEig|tz] -cg=[gridName] -alwaysCompute=[0|1] -ng=<num-refinement-levels>
#
$check="cgWave.check";
# 
# Set default parameters: 
$cg="square"; $option="planeWave"; 
$cmdFile="planeWave.cmd"; 
$CGBUILDPREFIX=$ENV{CGBUILDPREFIX};
$CGWAVE=$ENV{CGWAVE}; # directory for cgWave repo
$cgWave = "$CGWAVE/bin/cgWave";  # command for cgWave
$cmdDir="$CGWAVE";  
# printf("here 1\n");
$tf=.5; $tp=.1; $order = "2"; $ng=3; $interp="i"; $cfl=.9; $radius=.5; $bg="box";
$resStart=1;  # starting resolution
$bc="d"; # d or n 
$bcApproach="oneSided"; # bc Approach : cbc, lcbc, oneSided
$rectangular="implicit"; # for ts=implicit, set rectangular=explicit to treat rectangular grids explicitly
$beta2=.5; $beta4=0.; $beta6=0.; $beta8=0.; # weights in implicit time-stepping 
$kx=1; $ky=0; $kz=0;  
$fx=2.; $fy=-1; $fz=-1; $ft=-1; # -1 : set equal to fx
# printf("here 2\n");
$tz="poly"; $degreeInSpace=2; $degreeInTime=2; $implicitUpwind=0;
$nTheta=1; $mr=1; $mz=1; $rad=1.; $mPhi=1; $mr=1; $mTheta=1;
$ts="explicit"; $dtMax=1e10; $takeImplicitFirstStep=0; 
$orderInTime=-1;  # -1 = use default
$upwind=0; 
$errorNorm=0; $method=""; 
$alwaysCompute=1; $saveVectorErrors=0; 
$numberOfDimensions=2; 
$meApproach="std";   # or "ha"
$solveri="yale"; $maxiti=2000; $rtoli=1.0e-10; $atoli=1.0e-10; # parameters for implicit time-stepping solver
# printf("here 3\n");
#
GetOptions( "name=s"=>\$name,"order=s"=>\$order,"ng=i"=>\$ng,"tf=f"=>\$tf,"interp=s"=>\$interp,\
            "fixed=s"=>\$fixed,"cfl=f"=>\$cfl,"alwaysCompute=i"=>\$alwaysCompute,"tp=f"=>\$tp,\
            "errorNorm=i"=>\$errorNorm,"cg=s"=>\$cg,"option=s"=>\$option,"upwind=i"=>\$upwind,\
            "kx=f"=>\$kx,"ky=f"=>\$ky,"kz=f"=>\$kz,"ts=s"=>\$ts,"dtMax=f"=>\$dtMax,"rad=f"=>\$rad,\
            "beta2=f"=>\$beta2,"beta4=f"=>\$beta4,"beta6=f"=>\$beta6,\
            "orderInTime=i"=>\$orderInTime,"nTheta=i"=>\$nTheta,"mr=i"=>\$mr,"mz=i"=>\$mz,"mPhi=i"=>\$mPhi,"mTheta=i"=>\$mTheta,\
            "implicitUpwind=i"=>\$implicitUpwind,"takeImplicitFirstStep=i"=>\$takeImplicitFirstStep,\
            "bcApproach=s"=>\$bcApproach,"bc=s"=>\$bc,"meApproach=s"=>\$meApproach,"rectangular=s"=>\$rectangular,\
            "tz=s"=>\$tz,"degreeInSpace=i"=>\$degreeInSpace, "degreeInTime=i"=>\$degreeInTime,\
            "solveri=s"=>\$solveri,"rtoli=f"=>\$rtoli,"atoli=f"=>\$atoli,"maxiti=i"=>\$maxiti,\
            "fx=f"=>\$fx,"fy=f"=>\$fy,"fz=f"=>\$fz,"ft=f"=>\$ft,"resStart=i"=>\$resStart );
# --------------------------------------------------------------------------
$name=$option; 
if( $option eq "tz" ){ $cmdFile="runs/tz/tz.cmd";  $known="-known=unknown"; }
if( $option eq "squareEig" ){ $cmdFile="runs/known/known.cmd";  $known="-known=squareEig"; }
if( $option eq "diskEig" ){ $cmdFile="runs/known/known.cmd";  $known="-known=diskEig"; }
if( $option eq "annulusEig" ){ $cmdFile="runs/known/known.cmd";  $known="-known=annulusEig"; }
if( $option eq "sphereEig" ){ $cmdFile="runs/known/known.cmd";  $known="-known=sphereEig"; }
if( $option eq "planeWave" ){ $cmdFile="runs/known/known.cmd";  $known="-known=planeWave"; }
if( $option eq "cylScat" ){ $cmdFile="runs/known/known.cmd";  $known="-known=cylScat"; }
if( $option eq "helmholtz" ){ $cmdFile="cmd/helmholtz.cmd";  }
if( $fy eq -1 ){ $fy=$fx; }
if( $fz eq -1 ){ $fz=$fx; }
if( $ft eq -1 ){ $ft=$fx; }
# 
if( $cg =~ /nonSquarenp/ ){ $bg="square"; }
if( $cg =~ /nonSquare/ ){ $bg="square"; }
if( $cg =~ /nonBoxnpp/ ){ $bg="box"; }
# 
if( $cg =~ /box*/ || $cg =~ /nonBox*/ || $cg =~ /unitBox*/ || $cg =~ /unitNonBox*/ || $cg =~ /refineBox*/ || $cg =~ /refineNonBox*/ ){ $numberOfDimensions=3; }
$extraLabel ="";
if( $ts eq "implicit" && $rectangular eq "implicit" ){ $extraLabel="Implicit"; }
if( $ts eq "implicit" && $rectangular eq "explicit" ){ $extraLabel="SPIE"; }
if( $implicitUpwind eq "0" ){ $extraLabel .= "UWC"; }
if( $bcApproach eq "cbc" ){ $extraLabel .=$bcApproach; }
if( $bc eq "n" ){ $extraLabel .= "Neumann"; }
#
if( $errorNorm eq 0 ){ $normName = "max"; }elsif( $errorNorm eq 1 ){ $normName = "L1";}\
   elsif( $errorNorm eq 2 ){ $normName = "L2"; }else{ $normName="UnknownNorm"; }
# 
$outputFile="$name$method$cg$extraLabel" . "Order$order" . $meApproach. $bcApproach . $normName . "NormConvTable.tex"; 
#
$caseName="$name$method$meApproach$bcApproach$cg$extraLabel\Order$order";
$caseName .= $normName . "Norm";
#
#
#
$numberOfComponents=1;
# 
$title= "grid  \& N \&  \$ u \$ ";
#
$labelMethod=$method;
if( $ts eq "implicit" ){ $extraCaptions = ", beta2=$beta2, beta4=$beta4,rectangular=$rectangular, implicitUpwind=$implicitUpwind, takeImplicitFirstStep=$takeImplicitFirstStep"; }
if( $option eq "tz" ){ $extraCaptions .= "degreeInSpace=$degreeInSpace, -degreeInTime=$degreeInTime, -fx=$fx -fy=$fy -fz=$fz -ft=$ft"; }
$extraCaptions .=  ", mTheta=$mTheta, mPhi=$mPhi, mr=$mr";
$caption= "\\caption\{CgWave, $name, $normName norm, order=\$$order\$, ts=$ts, orderInTime=$orderInTime, dtMax0=\$$dtMax\$, \$t=$tf\$, cfl=\$$cfl\$, upwind=$upwind, bc=$bc, bcApproach=$bcApproach, meApproach=$meApproach, $known, kx=$kx, ky=$ky, kz=$kz, nTheta=$nTheta, mr=$mr, mz=$mz, rad=$rad, tz=$tz, solveri=$solveri, rtoli=$rtoli, atoli=$atoli, maxiti=$maxiti, $extraCaptions, $date}\\label\{table:$name" . $method . "Order$order$normName}"; 
# 
$options = "-cfl=$cfl -tf=$tf -tp=$tp -kx=$kx -ky=$ky -kz=$kz -fx=$fx -fy=$fy -fz=$fz -ft=$ft -nTheta=$nTheta -mTheta=$mTheta -mz=$mz -mPhi=$mPhi -mr=$mr -rad=$rad -ts=$ts -orderInTime=$orderInTime -upwind=$upwind -implicitUpwind=$implicitUpwind -rectangular=$rectangular -bc=$bc -bcApproach=$bcApproach -meApproach=$meApproach $known -go=go";
if( $option eq "tz" ){ $options .= " -tz=$tz -degreeInSpace=$degreeInSpace -degreeInTime=$degreeInTime -fx=$fx -fy=$fy -fz=$fz -ft=$ft -beta2=$beta2 -beta4=$beta4"; }
$options .= " -solveri=$solveri -rtoli=$rtoli -atoli=$atoli -maxiti=$maxiti  -takeImplicitFirstStep=$takeImplicitFirstStep";
if( $ts eq "implicit" ){ $options .= " -beta2=$beta2 -beta4=$beta4"; }
#
$suffix="";
if( ($upwind == 1 ) && ($order eq 4) ){ $suffix=".ng3"; }
if( ($upwind == 1 ) && ($order eq 6) ){ $suffix=".ng4"; }
if( ($upwind == 1 ) && ($order eq 8) ){ $suffix=".ng5"; }
$grid1=$cg . "2";   $gName1 = $cg . "e2.order$order$suffix"; 
$grid2=$cg . "4";   $gName2 = $cg . "e4.order$order$suffix"; 
$grid3=$cg . "8";   $gName3 = $cg . "e8.order$order$suffix"; 
$grid4=$cg . "16";  $gName4 = $cg . "e16.order$order$suffix"; 
$grid5=$cg . "32";  $gName5 = $cg . "e32.order$order$suffix"; 
$grid6=$cg . "64";  $gName6 = $cg . "e64.order$order$suffix"; 
# Special cases; 
if( $cg =~ /nonSquarenp/ ){\
$grid1=$cg . "1";   $gName1 = "nonSquare8np.order$order$suffix"; \
$grid2=$cg . "2";   $gName2 = "nonSquare16np.order$order$suffix"; \
$grid3=$cg . "4";   $gName3 = "nonSquare32np.order$order$suffix"; \
$grid4=$cg . "8";   $gName4 = "nonSquare64np.order$order$suffix"; \
$grid5=$cg . "16";  $gName5 = "nonSquare128np.order$order$suffix";\
$grid6=$cg . "32";  $gName6 = "nonSquare256np.order$order$suffix";\
}
if( $cg =~ /nonBoxnpp/ ){\
$grid1=$cg . "1";   $gName1 = "nonBox2npp.order$order$suffix"; \
$grid2=$cg . "2";   $gName2 = "nonBox4npp.order$order$suffix"; \
$grid3=$cg . "4";   $gName3 = "nonBox8npp.order$order$suffix"; \
$grid4=$cg . "8";   $gName4 = "nonBox16npp.order$order$suffix"; \
$grid5=$cg . "16";  $gName5 = "nonBox32npp.order$order$suffix";\
$grid6=$cg . "32";  $gName6 = "nonBox64npp.order$order$suffix";\
}
if( $cg =~ /box/ ){\
$grid1=$cg . "1";   $gName1 = "box1.order$order$suffix"; \
$grid2=$cg . "2";   $gName2 = "box2.order$order$suffix"; \
$grid3=$cg . "4";   $gName3 = "box4.order$order$suffix"; \
$grid4=$cg . "8";   $gName4 = "box8.order$order$suffix"; \
$grid5=$cg . "16";  $gName5 = "box16.order$order$suffix";\
$grid6=$cg . "32";  $gName6 = "box32.order$order$suffix";\
}
if( $cg =~ /boxp/ ){\
$grid1=$cg . "1";   $gName1 = "box1p.order$order$suffix"; \
$grid2=$cg . "2";   $gName2 = "box2p.order$order$suffix"; \
$grid3=$cg . "4";   $gName3 = "box4p.order$order$suffix"; \
$grid4=$cg . "8";   $gName4 = "box8p.order$order$suffix"; \
$grid5=$cg . "16";  $gName5 = "box16p.order$order$suffix";\
$grid6=$cg . "32";  $gName6 = "box32p.order$order$suffix";\
}
if( $cg =~ /nonBox/ ){\
$grid1=$cg . "1";   $gName1 = "nonBox2.order$order$suffix"; \
$grid2=$cg . "2";   $gName2 = "nonBox4.order$order$suffix"; \
$grid3=$cg . "4";   $gName3 = "nonBox8.order$order$suffix"; \
$grid4=$cg . "8";   $gName4 = "nonBox16.order$order$suffix"; \
$grid5=$cg . "16";  $gName5 = "nonBox32.order$order$suffix";\
$grid6=$cg . "32";  $gName6 = "nonBox64.order$order$suffix";\
}
if( $cg =~ /square/ ){\
$grid1=$cg . "8";   $gName1 = "square8.order$order$suffix"; \
$grid2=$cg . "16";   $gName2 = "square16.order$order$suffix"; \
$grid3=$cg . "32";   $gName3 = "square32.order$order$suffix"; \
$grid4=$cg . "64";   $gName4 = "square64.order$order$suffix"; \
$grid5=$cg . "128";  $gName5 = "square128.order$order$suffix";\
$grid6=$cg . "256";  $gName6 = "square256.order$order$suffix";\
$grid7=$cg . "512";  $gName7 = "square512.order$order$suffix";\
$grid8=$cg . "1024"; $gName8 = "square1024.order$order$suffix";\
}
if( $cg =~ /squarep/ ){\
$grid1=$cg . "8";   $gName1 = "square8p.order$order$suffix"; \
$grid2=$cg . "16";   $gName2 = "square16p.order$order$suffix"; \
$grid3=$cg . "32";   $gName3 = "square32p.order$order$suffix"; \
$grid4=$cg . "64";   $gName4 = "square64p.order$order$suffix"; \
$grid5=$cg . "128";  $gName5 = "square128p.order$order$suffix";\
$grid6=$cg . "256";  $gName6 = "square256p.order$order$suffix";\
}
if( $cg =~ /nonSquare/ ){\
$grid1=$cg . "8";   $gName1 = "nonSquare8.order$order$suffix"; \
$grid2=$cg . "16";   $gName2 = "nonSquare16.order$order$suffix"; \
$grid3=$cg . "32";   $gName3 = "nonSquare32.order$order$suffix"; \
$grid4=$cg . "64";   $gName4 = "nonSquare64.order$order$suffix"; \
$grid5=$cg . "128";  $gName5 = "nonSquare128.order$order$suffix";\
$grid6=$cg . "256";  $gName6 = "nonSquare256.order$order$suffix";\
}
if( $cg =~ /nonSquarep/ ){\
$grid1=$cg . "8";   $gName1 = "nonSquare8p.order$order$suffix"; \
$grid2=$cg . "16";   $gName2 = "nonSquare16p.order$order$suffix"; \
$grid3=$cg . "32";   $gName3 = "nonSquare32p.order$order$suffix"; \
$grid4=$cg . "64";   $gName4 = "nonSquare64p.order$order$suffix"; \
$grid5=$cg . "128";  $gName5 = "nonSquare128p.order$order$suffix";\
$grid6=$cg . "256";  $gName6 = "nonSquare256p.order$order$suffix";\
}
if( $cg =~ /rotatedSquare/ ){\
$grid1=$cg . "8";    $gName1 = "rotatedSquare8.order$order$suffix"; \
$grid2=$cg . "16";   $gName2 = "rotatedSquare16.order$order$suffix"; \
$grid3=$cg . "32";   $gName3 = "rotatedSquare32.order$order$suffix"; \
$grid4=$cg . "64";   $gName4 = "rotatedSquare64.order$order$suffix"; \
$grid5=$cg . "128";  $gName5 = "rotatedSquare128.order$order$suffix";\
$grid6=$cg . "256";  $gName6 = "rotatedSquare256.order$order$suffix";\
$grid7=$cg . "512";  $gName7 = "rotatedSquare512.order$order$suffix";\
$grid8=$cg . "1024"; $gName8 = "rotatedSquare1024.order$order$suffix";\
}
if( $cg =~ /annulus/ ){\
$grid1=$cg . "2";   $gName1 = "annulus2.order$order$suffix"; \
$grid2=$cg . "4";   $gName2 = "annulus4.order$order$suffix"; \
$grid3=$cg . "8";   $gName3 = "annulus8.order$order$suffix"; \
$grid4=$cg . "16";  $gName4 = "annulus16.order$order$suffix"; \
$grid5=$cg . "32";  $gName5 = "annulus32.order$order$suffix";\
$grid6=$cg . "64";  $gName6 = "annulus64.order$order$suffix";\
}
if( $cg =~ /quarterCyl/ ){\
$grid1=$cg . "1";   $gName1 = "quarterCyl1.order$order$suffix"; \
$grid2=$cg . "2";   $gName1 = "quarterCyl2.order$order$suffix"; \
$grid3=$cg . "4";   $gName2 = "quarterCyl4.order$order$suffix"; \
$grid4=$cg . "8";   $gName3 = "quarterCyl8.order$order$suffix"; \
$grid5=$cg . "16";  $gName4 = "quarterCyl16.order$order$suffix"; \
$grid6=$cg . "32";  $gName5 = "quarterCyl32.order$order$suffix";\
$grid7=$cg . "64";  $gName6 = "quarterCyl64.order$order$suffix";\
}
# For implicit schemes we set dtMax to be proportional to dx
if( $ng > 0 && $resStart<=1 ){ $grid=$grid1; $res=1;   $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName1 $options -dtMax=$dtm";}
if( $ng > 1 && $resStart<=2 ){ $grid=$grid2; $res=2;   $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName2 $options -dtMax=$dtm";}
if( $ng > 2 && $resStart<=3 ){ $grid=$grid3; $res=4;   $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName3 $options -dtMax=$dtm";}
if( $ng > 3 && $resStart<=4 ){ $grid=$grid4; $res=8;   $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName4 $options -dtMax=$dtm";}
if( $ng > 4 && $resStart<=5 ){ $grid=$grid5; $res=16;  $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName5 $options -dtMax=$dtm";}
if( $ng > 5 && $resStart<=6 ){ $grid=$grid6; $res=32;  $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName6 $options -dtMax=$dtm";}
if( $ng > 6 && $resStart<=7 ){ $grid=$grid7; $res=64;  $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName7 $options -dtMax=$dtm";}
if( $ng > 7 && $resStart<=8 ){ $grid=$grid8; $res=128; $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName8 $options -dtMax=$dtm";}
$closeFile="true";
# -------------------------------------------------------------------------------
exit
