#
# Measure convergence rates for CgWave
#
#     conv.p tests.conv -option=[planeWave|helmholtz|diskEig|annulusEig|tz] -cg=[gridName] -alwaysCompute=[0|1] -ng=<num-refinement-levels>
#
$check="cgWave.check";
# 
# Set default parameters: 
$cg="square"; $option="planeWave"; 
$cmdFile="planeWave.cmd"; 
$CGBUILDPREFIX=$ENV{CGBUILDPREFIX};
$CGWAVE=$ENV{CGWAVE}; # directory for cgWave repo
$cgWave = "$CGWAVE/bin/cgWave";  # command for cgWave
$cmdDir="$CGWAVE";  
$tf=.5; $tp=.1; $order = "2"; $ng=3; $interp="i"; $cfl=.9; $radius=.5; $bg="box";
$bc=d"; # d or n 
$bcApproach="oneSided"; # bc Approach : cbc, lcbc, oneSided
$kx=1; $ky=0; $kz=0; 
$tz="poly"; $degreeInSpace=2; $degreeInTime=2; 
$nBessel=1; $mTheta=1; 
$ts="explicit"; $dtMax=1e10; 
$orderInTime=-1;  # -1 = use default
$upwind=0; 
$errorNorm=0; $method=""; 
$alwaysCompute=1; $saveVectorErrors=0; 
$numberOfDimensions=2; 
#
GetOptions( "name=s"=>\$name,"order=s"=>\$order,"ng=i"=>\$ng,"tf=f"=>\$tf,"interp=s"=>\$interp,\
            "fixed=s"=>\$fixed,"cfl=f"=>\$cfl,"alwaysCompute=i"=>\$alwaysCompute,"tp=f"=>\$tp,\
            "errorNorm=i"=>\$errorNorm,"cg=s"=>\$cg,"option=s"=>\$option,"upwind=i"=>\$upwind,\
            "kx=f"=>\$kx,"ky=f"=>\$ky,"kz=f"=>\$kz,"ts=s"=>\$ts,"dtMax=f"=>\$dtMax,\
            "orderInTime=i"=>\$orderInTime,"nBessel=i"=>\$nBessel,"mTheta=i"=>\$mTheta,\
            "bcApproach=s"=>\$bcApproach,"bc=s"=>\$bc,\
            "tz=s"=>\$tz,"degreeInSpace=i"=>\$degreeInSpace, "degreeInTime=i"=>\$degreeInTime );
# --------------------------------------------------------------------------
$name=$option; 
if( $option eq "tz" ){ $cmdFile="runs/tz/tz.cmd";  $known="-known=unknown"; }
if( $option eq "diskEig" ){ $cmdFile="runs/known/known.cmd";  $known="-known=diskEig"; }
if( $option eq "annulusEig" ){ $cmdFile="runs/known/known.cmd";  $known="-known=annulusEig"; }
if( $option eq "planeWave" ){ $cmdFile="runs/known/known.cmd";  $known="-known=planeWave"; }
if( $option eq "helmholtz" ){ $cmdFile="cmd/helmholtz.cmd";  }
# 
if( $cg =~ /nonSquarenp/ ){ $bg="square"; }
if( $cg =~ /nonSquare/ ){ $bg="square"; }
if( $cg =~ /nonBoxnpp/ ){ $bg="box"; }
# 
if( $cg =~ /box*/ || $cg =~ /nonBox*/ || $cg =~ /unitBox*/ || $cg =~ /unitNonBox*/ || $cg =~ /refineBox*/ || $cg =~ /refineNonBox*/ ){ $numberOfDimensions=3; }
$extraLabel ="";
if( $bcApproach eq "cbc" ){ $extraLabel=$bcApproach; }
if( $bc eq "n" ){ $extraLabel .= "Neumann"; }
#
if( $errorNorm eq 0 ){ $normName = "max"; }elsif( $errorNorm eq 1 ){ $normName = "L1";}\
   elsif( $errorNorm eq 2 ){ $normName = "L2"; }else{ $normName="UnknownNorm"; }
# 
$outputFile="$name$method$cg$extraLabel" . "Order$order" . $normName . "NormConvTable.tex"; 
#
$caseName="$name$method$cg\Order$order";
$caseName .= $normName . "Norm";
#
#
#
$numberOfComponents=1;
# 
$title= "grid  \& N \&  \$ u \$ ";
#
$labelMethod=$method;
$caption= "\\caption\{CgWave, $name, $normName norm, order=\$$order\$, ts=$ts, orderInTime=$orderInTime, dtMax0=\$$dtMax\$, \$t=$tf\$, cfl=\$$cfl\$, upwind=$upwind, bc=$bc, bcApproach=$bcApproach, $known, kx=$kx, ky=$ky, kz=$kz, nBessel=$nBessel, mTheta=$mTheta, -tz=$tz, degreeInSpace=$degreeInSpace, -degreeInTime=$degreeInTime, $date}\\label\{table:$name" . $method . "Order$order$normName}"; 
# 
$options = "-cfl=$cfl -tf=$tf -tp=$tp -kx=$kx -ky=$ky -kz=$kz -nBessel=$nBessel -mTheta=$mTheta -ts=$ts -orderInTime=$orderInTime -upwind=$upwind -bc=$bc -bcApproach=$bcApproach $known -go=go";
if( $option eq "tz" ){ $options .= " -tz=$tz -degreeInSpace=$degreeInSpace -degreeInTime=$degreeInTime"; }
#
$suffix="";
if( ($upwind == 1 ) && ($order eq 4) ){ $suffix=".ng3"; }
if( ($upwind == 1 ) && ($order eq 6) ){ $suffix=".ng4"; }
$grid1=$cg . "2";   $gName1 = $cg . "e2.order$order$suffix"; 
$grid2=$cg . "4";   $gName2 = $cg . "e4.order$order$suffix"; 
$grid3=$cg . "8";   $gName3 = $cg . "e8.order$order$suffix"; 
$grid4=$cg . "16";  $gName4 = $cg . "e16.order$order$suffix"; 
$grid5=$cg . "32";  $gName5 = $cg . "e32.order$order$suffix"; 
$grid6=$cg . "64";  $gName6 = $cg . "e64.order$order$suffix"; 
# Special cases; 
if( $cg =~ /nonSquarenp/ ){\
$grid1=$cg . "1";   $gName1 = "nonSquare8np.order$order$suffix"; \
$grid2=$cg . "2";   $gName2 = "nonSquare16np.order$order$suffix"; \
$grid3=$cg . "4";   $gName3 = "nonSquare32np.order$order$suffix"; \
$grid4=$cg . "8";   $gName4 = "nonSquare64np.order$order$suffix"; \
$grid5=$cg . "16";  $gName5 = "nonSquare128np.order$order$suffix";\
$grid6=$cg . "32";  $gName6 = "nonSquare256np.order$order$suffix";\
}
if( $cg =~ /nonBoxnpp/ ){\
$grid1=$cg . "1";   $gName1 = "nonBox2npp.order$order$suffix"; \
$grid2=$cg . "2";   $gName2 = "nonBox4npp.order$order$suffix"; \
$grid3=$cg . "4";   $gName3 = "nonBox8npp.order$order$suffix"; \
$grid4=$cg . "8";   $gName4 = "nonBox16npp.order$order$suffix"; \
$grid5=$cg . "16";  $gName5 = "nonBox32npp.order$order$suffix";\
$grid6=$cg . "32";  $gName6 = "nonBox64npp.order$order$suffix";\
}
if( $cg =~ /box/ ){\
$grid1=$cg . "1";   $gName1 = "box1.order$order$suffix"; \
$grid2=$cg . "2";   $gName2 = "box2.order$order$suffix"; \
$grid3=$cg . "4";   $gName3 = "box4.order$order$suffix"; \
$grid4=$cg . "8";   $gName4 = "box8.order$order$suffix"; \
$grid5=$cg . "16";  $gName5 = "box16.order$order$suffix";\
$grid6=$cg . "32";  $gName6 = "box32.order$order$suffix";\
}
if( $cg =~ /boxp/ ){\
$grid1=$cg . "1";   $gName1 = "box1p.order$order$suffix"; \
$grid2=$cg . "2";   $gName2 = "box2p.order$order$suffix"; \
$grid3=$cg . "4";   $gName3 = "box4p.order$order$suffix"; \
$grid4=$cg . "8";   $gName4 = "box8p.order$order$suffix"; \
$grid5=$cg . "16";  $gName5 = "box16p.order$order$suffix";\
$grid6=$cg . "32";  $gName6 = "box32p.order$order$suffix";\
}
if( $cg =~ /nonBox/ ){\
$grid1=$cg . "1";   $gName1 = "nonBox2.order$order$suffix"; \
$grid2=$cg . "2";   $gName2 = "nonBox4.order$order$suffix"; \
$grid3=$cg . "4";   $gName3 = "nonBox8.order$order$suffix"; \
$grid4=$cg . "8";   $gName4 = "nonBox16.order$order$suffix"; \
$grid5=$cg . "16";  $gName5 = "nonBox32.order$order$suffix";\
$grid6=$cg . "32";  $gName6 = "nonBox64.order$order$suffix";\
}
if( $cg =~ /square/ ){\
$grid1=$cg . "8";   $gName1 = "square8.order$order$suffix"; \
$grid2=$cg . "16";   $gName2 = "square16.order$order$suffix"; \
$grid3=$cg . "32";   $gName3 = "square32.order$order$suffix"; \
$grid4=$cg . "64";   $gName4 = "square64.order$order$suffix"; \
$grid5=$cg . "128";  $gName5 = "square128.order$order$suffix";\
$grid6=$cg . "256";  $gName6 = "square256.order$order$suffix";\
$grid7=$cg . "512";  $gName7 = "square512.order$order$suffix";\
$grid8=$cg . "1024"; $gName8 = "square1024.order$order$suffix";\
}
if( $cg =~ /squarep/ ){\
$grid1=$cg . "8";   $gName1 = "square8p.order$order$suffix"; \
$grid2=$cg . "16";   $gName2 = "square16p.order$order$suffix"; \
$grid3=$cg . "32";   $gName3 = "square32p.order$order$suffix"; \
$grid4=$cg . "64";   $gName4 = "square64p.order$order$suffix"; \
$grid5=$cg . "128";  $gName5 = "square128p.order$order$suffix";\
$grid6=$cg . "256";  $gName6 = "square256p.order$order$suffix";\
}
if( $cg =~ /nonSquare/ ){\
$grid1=$cg . "8";   $gName1 = "nonSquare8.order$order$suffix"; \
$grid2=$cg . "16";   $gName2 = "nonSquare16.order$order$suffix"; \
$grid3=$cg . "32";   $gName3 = "nonSquare32.order$order$suffix"; \
$grid4=$cg . "64";   $gName4 = "nonSquare64.order$order$suffix"; \
$grid5=$cg . "128";  $gName5 = "nonSquare128.order$order$suffix";\
$grid6=$cg . "256";  $gName6 = "nonSquare256.order$order$suffix";\
}
if( $cg =~ /nonSquarep/ ){\
$grid1=$cg . "8";   $gName1 = "nonSquare8p.order$order$suffix"; \
$grid2=$cg . "16";   $gName2 = "nonSquare16p.order$order$suffix"; \
$grid3=$cg . "32";   $gName3 = "nonSquare32p.order$order$suffix"; \
$grid4=$cg . "64";   $gName4 = "nonSquare64p.order$order$suffix"; \
$grid5=$cg . "128";  $gName5 = "nonSquare128p.order$order$suffix";\
$grid6=$cg . "256";  $gName6 = "nonSquare256p.order$order$suffix";\
}
if( $cg =~ /annulus/ ){\
$grid1=$cg . "2";   $gName1 = "annulus2.order$order$suffix"; \
$grid2=$cg . "4";   $gName2 = "annulus4.order$order$suffix"; \
$grid3=$cg . "8";   $gName3 = "annulus8.order$order$suffix"; \
$grid4=$cg . "16";  $gName4 = "annulus16.order$order$suffix"; \
$grid5=$cg . "32";  $gName5 = "annulus32.order$order$suffix";\
$grid6=$cg . "64";  $gName6 = "annulus64.order$order$suffix";\
}
# For implicit schemes we set dtMax to be proportional to dx
if( $ng > 0 ){ $grid=$grid1; $res=1;   $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName1 $options -dtMax=$dtm";  }
if( $ng > 1 ){ $grid=$grid2; $res=2;   $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName2 $options -dtMax=$dtm";}
if( $ng > 2 ){ $grid=$grid3; $res=4;   $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName3 $options -dtMax=$dtm";}
if( $ng > 3 ){ $grid=$grid4; $res=8;   $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName4 $options -dtMax=$dtm";}
if( $ng > 4 ){ $grid=$grid5; $res=16;  $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName5 $options -dtMax=$dtm";}
if( $ng > 5 ){ $grid=$grid6; $res=32;  $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName6 $options -dtMax=$dtm";}
if( $ng > 6 ){ $grid=$grid7; $res=64;  $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName7 $options -dtMax=$dtm";}
if( $ng > 7 ){ $grid=$grid8; $res=128; $dtm=$dtMax/$res; $cmd="$cgWave -noplot $cmdDir/$cmdFile -g=$gName8 $options -dtMax=$dtm";}
$closeFile="true";
# -------------------------------------------------------------------------------
exit
